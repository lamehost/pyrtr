"""Interface towards the rpki-client JSON file"""

import os
from ipaddress import ip_network
from typing import Generator, TypedDict

import orjson

from .pdu import ipv4_prefix, ipv6_prefix


class Metadata(TypedDict):
    """File metadata"""

    buildmachine: str
    buildtime: str
    elapsedtime: int
    usertime: int
    systemtime: int
    roas: int
    failedroas: int
    invalidroas: int
    aspas: int
    failedaspas: int
    invalidaspas: int
    bgpsec_pubkeys: int
    certificates: int
    invalidcertificates: int
    nonfunctionalcas: int
    taks: int
    tals: int
    invalidtals: int
    talfiles: list[str]
    manifests: int
    failedmanifests: int
    crls: int
    gbrs: int
    repositories: int
    vrps: int
    uniquevrps: int
    vsps: int
    uniquevsps: int
    vaps: int
    uniquevaps: int
    cachedir_new_files: int
    cachedir_del_files: int
    cachedir_del_dirs: int
    cachedir_superfluous_files: int
    cachedir_del_superfluous_files: int


class ROA(TypedDict):
    """RPKI ROA"""

    asn: int
    prefix: str
    maxLength: int
    ta: str
    expires: int


class BGPSecKey(TypedDict):
    """BGPSec key"""

    asn: int
    key: str
    pubkey: str
    ta: str
    expires: int


class NonFuncCA(TypedDict):
    """Non functional CA"""

    location: str
    ta: str
    caRepository: str
    rpkiManifest: str
    ski: str


class ASPA(TypedDict):
    """ASPA object"""

    customer_asid: int
    expires: int
    providers: list[int]


class JSON(TypedDict):
    """Defines the field in the JSON file"""

    metadata: Metadata
    roas: list[ROA]
    bgpsec_keys: list[BGPSecKey]
    nonfunc_cas: list[NonFuncCA]
    aspas: list[ASPA]


class RPKIClient:
    """
    Interface for the JSON file as generated by rpki_client.

    Arguments:
    ----------
    path: str | os.PathLike[str]
        Path to the file
    """

    path: str | os.PathLike[str]
    data: JSON

    def __init__(self, path: str | os.PathLike[str]) -> None:
        self.path = path
        self.read()

    def read(self) -> None:
        """
        Reads the file
        """
        with open(self.path, encoding="utf-8") as file:
            self.data = orjson.loads(file.read())  # pylint: disable=no-member

    @property
    def prefixes(self) -> Generator[ipv4_prefix.IPv4Prefix | ipv6_prefix.IPv6Prefix, None, None]:
        """
        List of prefixes

        Returns:
        --------
        Generator[ipv4_prefix.IPv4Prefix | ipv6_prefix.IPv6Prefix, None, None]:
            Yield IPv4 and IPv6 prefixes
        """
        for roa in self.data["roas"]:
            prefix = ip_network(roa["prefix"])
            if prefix.version == 4:
                yield ipv4_prefix.IPv4Prefix(
                    version=0,
                    type=4,
                    zero=0,
                    length=20,
                    flags=1,
                    prefix_length=prefix.prefixlen,
                    max_length=int(roa["maxLength"]),
                    padding=0,
                    prefix=prefix.network_address.packed,
                    asn=int(roa["asn"]),
                )
            else:
                yield ipv6_prefix.IPv6Prefix(
                    version=0,
                    type=6,
                    zero=0,
                    length=20,
                    flags=1,
                    prefix_length=prefix.prefixlen,
                    max_length=int(roa["maxLength"]),
                    padding=0,
                    prefix=prefix.network_address.packed,
                    asn=int(roa["asn"]),
                )

    @property
    def metadata(self) -> Metadata:
        """
        Returns the file metadata

        Returns:
        --------
        Metadata: the file metadata
        """
        return self.data["metadata"]

    @property
    def roas(self) -> Generator[ROA, None, None]:
        """
        Returns the list of ROAS

        Returns:
        --------
        Generator[ROA, None, None]: Yield ROAs
        """
        yield from self.data["roas"]
